// SaaS AI Dental Receptionist - Multi-tenant Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// TENANTS (Clínicas)
model Tenant {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  city              String
  phone             String
  email             String?
  status            TenantStatus @default(TRIAL)
  subscriptionPlan  SubscriptionPlan @default(BASIC)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  users             User[]
  clinicConfiguration ClinicConfiguration?
  patients          Patient[]
  calls             Call[]
  appointments      Appointment[]
  aiPrompts         AiPrompt[]
  faqs              Faq[]
  dailyMetrics      DailyMetric[]
  subscriptions     Subscription[]
  usageLogs         UsageLog[]

  @@map("tenants")
}

// USERS (Usuarios del SaaS)
model User {
  id           String     @id @default(cuid())
  tenantId     String
  email        String
  name         String
  role         UserRole   @default(RECEPTIONIST)
  passwordHash String     @map("password_hash")
  isActive     Boolean    @default(true) @map("is_active")
  lastLogin    DateTime?  @map("last_login")
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  // Relations
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@map("users")
}

// CLINIC CONFIGURATIONS
model ClinicConfiguration {
  id                    String   @id @default(cuid())
  tenantId              String   @unique
  workingHours          String   @map("working_hours") // JSON string
  appointmentDuration    Int      @default(30) @map("appointment_duration")
  calendarProvider      String   @default("google") @map("calendar_provider")
  calendarId            String?  @map("calendar_id")
  timezone              String   @default("Europe/Madrid")
  services              String   @map("services") // JSON string
  autoConfirmAppointments Boolean @default(true) @map("auto_confirm_appointments")
  smsEnabled            Boolean  @default(false) @map("sms_enabled")
  emailEnabled          Boolean  @default(true) @map("email_enabled")
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("clinic_configurations")
}

// PATIENTS
model Patient {
  id            String    @id @default(cuid())
  tenantId      String
  name          String
  phone         String
  email         String?
  isNewPatient  Boolean   @default(true) @map("is_new_patient")
  dateOfBirth   DateTime? @map("date_of_birth")
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  calls         Call[]
  appointments  Appointment[]

  @@unique([tenantId, phone])
  @@map("patients")
}

// CALLS
model Call {
  id             String       @id @default(cuid())
  tenantId       String
  patientId      String?
  callSid        String?      @unique @map("call_sid")
  phoneFrom      String       @map("phone_from")
  phoneTo        String       @map("phone_to")
  status         CallStatus
  durationSeconds Int?        @map("duration_seconds")
  startedAt      DateTime     @map("started_at")
  endedAt        DateTime?    @map("ended_at")
  createdAt      DateTime     @default(now())

  // Relations
  tenant         Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient        Patient?     @relation(fields: [patientId], references: [id])
  callLogs       CallLog[]
  appointments   Appointment[]

  @@map("calls")
}

// CALL LOGS (Transcripciones y eventos)
model CallLog {
  id             String      @id @default(cuid())
  callId         String
  eventType      CallLogType @map("event_type")
  content        String
  timestamp      DateTime
  confidenceScore Float?      @map("confidence_score")
  metadata       String?     // JSON string

  // Relations
  call           Call        @relation(fields: [callId], references: [id], onDelete: Cascade)

  @@map("call_logs")
}

// APPOINTMENTS
model Appointment {
  id             String           @id @default(cuid())
  tenantId       String
  patientId      String
  callId         String?
  calendarEventId String?         @map("calendar_event_id")
  title          String
  description    String?
  startTime      DateTime         @map("start_time")
  endTime        DateTime         @map("end_time")
  serviceType    String           @map("service_type")
  urgencyLevel   UrgencyLevel     @map("urgency_level")
  status         AppointmentStatus @default(SCHEDULED)
  notes          String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  // Relations
  tenant         Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  patient        Patient          @relation(fields: [patientId], references: [id])
  call           Call?            @relation(fields: [callId], references: [id])

  @@map("appointments")
}

// AI PROMPTS (Configuración por tenant)
model AiPrompt {
  id             String     @id @default(cuid())
  tenantId       String
  promptType     PromptType @map("prompt_type")
  templateContent String     @map("template_content")
  variables      String?    // JSON string
  isActive       Boolean    @default(true) @map("is_active")
  version        Int        @default(1)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  // Relations
  tenant         Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, promptType, version])
  @@map("ai_prompts")
}

// FAQs por tenant
model Faq {
  id        String   @id @default(cuid())
  tenantId  String
  question  String
  answer    String
  category  String?
  priority  Int      @default(0)
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("faqs")
}

// METRICS (Agregados para dashboard)
model DailyMetric {
  id                    String   @id @default(cuid())
  tenantId              String
  date                  DateTime @unique
  totalCalls            Int      @default(0) @map("total_calls")
  answeredCalls          Int      @default(0) @map("answered_calls")
  missedCalls           Int      @default(0) @map("missed_calls")
  appointmentsScheduled Int      @default(0) @map("appointments_scheduled")
  newPatients           Int      @default(0) @map("new_patients")
  totalCallDuration     Int      @default(0) @map("total_call_duration")
  aiCostCents           Int      @default(0) @map("ai_cost_cents")
  createdAt             DateTime @default(now())

  // Relations
  tenant                Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, date])
  @@map("daily_metrics")
}

// BILLING
model Subscription {
  id                String           @id @default(cuid())
  tenantId          String
  plan              SubscriptionPlan
  priceCents        Int              @map("price_cents")
  billingCycle      BillingCycle     @map("billing_cycle")
  status            SubscriptionStatus @default(ACTIVE)
  currentPeriodStart DateTime         @map("current_period_start")
  currentPeriodEnd   DateTime         @map("current_period_end")
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  tenant            Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

// USAGE LOGS (Para control de costes)
model UsageLog {
  id          String      @id @default(cuid())
  tenantId    String
  usageType   UsageType   @map("usage_type")
  quantity    Int
  costCents   Int         @map("cost_cents")
  referenceId String?     @map("reference_id")
  createdAt   DateTime    @default(now())

  // Relations
  tenant      Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("usage_logs")
}

// ENUMS
enum TenantStatus {
  TRIAL
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum SubscriptionPlan {
  BASIC
  PRO
  ENTERPRISE
}

enum UserRole {
  OWNER
  ADMIN
  RECEPTIONIST
}

enum CallStatus {
  RINGING
  IN_PROGRESS
  COMPLETED
  FAILED
  NO_ANSWER
}

enum CallLogType {
  TRANSCRIPTION
  USER_SPEECH
  AI_RESPONSE
  SYSTEM_EVENT
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum UrgencyLevel {
  LOW
  MEDIUM
  HIGH
  EMERGENCY
}

enum PromptType {
  SYSTEM
  GREETING
  QUALIFICATION
  SCHEDULING
  FAREWELL
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
}

enum UsageType {
  CALL_MINUTE
  AI_REQUEST
  SMS_SENT
  EMAIL_SENT
}